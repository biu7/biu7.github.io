Title: 逆向某疫苗预约 App 并成功帮女朋友抢到九价 HPV 疫苗
Date: 2019-11-06
Category: 逆向
Slug: hpv_reservation
Authors: qi
Summary: 逆向了某疫苗预约 App，写代码抢到 HPV 九价疫苗的故事


注：迫于最近抓了好多搞爬虫的，因此以下不出现具体的省市名及 App 名称

自 HPV 疫苗国内上市已经有一年多了，然而由于疫苗产能不足的原因，各地疫苗都是供不应求。打电话给上海各个接种点得到的回复都是已经排队到一年以后了 orz...

无奈之下只好各种找疫苗代约，他们真的是坐地起价啊！预约费几乎都是两千元以上，有的甚至算上疫苗一共 8888 ？？？（此处有科普：一针疫苗 + 注射费 = 1326 元，三针约四千元），简直是抢钱。

算起来女朋友还有一年半才到26岁，也并不是很急，毕竟 26.5 岁之前打第一针就可以。因此开始查找上海附近有哪些地方开放线上预约的，一番查找之后（几个月过去了。。。），发现 隔壁 XX 市是在 App 上进行预约的，嘿这不就到了我的老本行了吗，是时候展现真正的技术了！

下载 App 后注册账号测试，软件看起来一股外包味，本来以为怕是没加密没加固轻松搞定，没想到抓包发现加密了：

![](https://img.biubiu7.cn/blog/201911060001.jpeg)

没办法，只能尝试逆向或者 Hook 看看了。

逆向是有点麻烦的，所以我们先用 Frida 找一下有没有明显是加密方法的函数，有的话就省事儿了。这里介绍一个工具：Brida，他是 Brup Suite 的一个插件，需要配合 Frida 使用，效果极佳。

打开 Brup Suite 和 Brida ，启动 Frida Server 然后一通操作，我们就得到了 App 的类列表，根据包名筛选一下，果然发现一个极其明显的类名：com.xxxx.xxx.utils.SecretKeyUtil，果断 Hook 掉，在 Brida 控制台会打印出类中的方法并逐个 Hook ：

![](https://img.biubiu7.cn/blog/201911060002.png)

通过这些方法名我们也能看出这个类是 AES 加密的实现类，考虑到 Java 中 AES 加密是有标准库的实现的，因此 App 使用的密钥及加密模式很有可能可以直接从这个类中找到。在 App 中做一些操作，尝试触发这个类的方法，结果如图：

![](https://img.biubiu7.cn/blog/201911060003.jpeg)
![](https://img.biubiu7.cn/blog/201911060004.jpeg)

上图中得到两个疑似加密 key 的字符串，另外还得到了加密前的原始字符串和加密结果。虽然没有得到加密模式及 AES 使用的偏移量，但也足够我们测试出具体的加密方式了。

测试加密方法的过程略过不谈。事实上对于加密方法的 Hook ，我们还可以直接 Hook Java 标准库的加密方法，以直接得到加密所需的参数。在抓包中可以看到，其实除了加密过的参数之外，还有一个疑似 MD5 处理的 sign 参数，这个参数就可以使用 Hook Java 标准库中的 MD5 方法，来得到 MD5 前的具体参数值，这个就不详细描述了，过程与上述过程类似。